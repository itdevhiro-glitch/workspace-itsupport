<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zeppelin â€” User Dashboard</title>
<link rel="icon" type="image/png" href="icov2.png" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  
  /* (DIUBAH) Variabel Tema disamakan dengan login.html */
  :root{
    --bg: #fef8f5; 
    --card: #ffffff;
    --muted: #6c757d;
    --text: #212529;
    --primary: #D9232D; /* Merah Zeppelin */
    --primary-hover: #B01B22; /* Merah hover */
    --accent: #F37321; /* Oranye Zeppelin */
    --success: #16a34a;
    --warning: #F37321; /* Oranye Zeppelin */
    --danger: #D9232D; /* Merah Zeppelin */
    --radius: 10px;
    --border-color: #fbe0dd; /* Border warna merah muda */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
  }
  [data-theme="dark"]{
    --bg:#221a1a;
    --card:#312525;
    --muted:#94a3b8;
    --text:#f1f5f9;
    --primary:#e54e58; /* Merah muda */
    --primary-hover:#d9232d;
    --border-color: #523f3f;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Inter', system-ui, Roboto, Arial, sans-serif; background:var(--bg);
    color:var(--text); padding:24px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  .app{max-width:1000px;margin:0 auto}
  header.app-header{
    display:flex; align-items:center; gap:16px; margin-bottom:24px; padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color); flex-wrap: wrap; 
  }
  .logo{
    width:48px; height:48px; border-radius:var(--radius);
    background:linear-gradient(135deg, var(--danger), var(--accent));
    display:flex; align-items:center; justify-content:center; color:#fff;
    font-weight:800; font-size:18px;
  }
  .title .name{font-size:22px;font-weight:800}
  .title .tag{font-size:13px;color:var(--muted);font-weight:500;}
  .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
  .btn{
    background:var(--primary); color:#fff; border:none; padding:9px 14px; border-radius:8px;
    cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:6px;
    font-size:14px; transition: background-color 0.2s ease; text-decoration: none; line-height: 1;
  }
  .btn:hover{ background: var(--primary-hover); }
  .btn.ghost{ background:transparent; border:1px solid var(--border-color); color:var(--text); font-weight: 500; }
  .btn.ghost:hover{ background: var(--border-color); }
  .btn:not(.ghost){ box-shadow: var(--shadow-sm); }
  .btn svg{width:16px;height:16px;stroke-width:2.5}
  
  .btn.urgent {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 4px 8px;
    font-size: 12px;
  }
  .btn.urgent:hover {
    background: var(--danger);
    color: #fff;
  }

  .card{
    background:var(--card); padding: 20px 24px; border-radius:var(--radius);
    box-shadow:var(--shadow-sm); border:1px solid var(--border-color);
  }
  h3 { font-size: 18px; font-weight: 700; margin-top: 0; margin-bottom: 16px; }
  .small{font-size:13px;color:var(--muted);font-weight:500;}

  .summary-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px; margin-bottom: 20px;
  }
  .summary-card {
    padding: 16px !important; border-radius: var(--radius) !important;
  }
  .summary-card .small { font-weight: 600; }
  .summary-card .count {
    font-size: 24px !important; font-weight: 800 !important;
    margin-top: 8px;
  }
  #summary-open .count { color: var(--warning); } /* Oranye */
  #summary-progress .count { color: #007bff; } /* Biru */
  #summary-closed .count { color: var(--success); } /* Hijau */

  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:600px}
  th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align: middle;}
  th{
    background:var(--bg); color:var(--muted); font-size:12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .status{
    display:inline-block; padding: 4px 12px; border-radius:999px;
    font-weight:600; font-size:12px; line-height: 1.5;
  }
  .s-open{background:#fffbeb;color:#b45309}
  .s-progress{background:#e0f2fe;color:#0284c7}
  .s-closed{background:#dcfce7;color:#16a34a}
  
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none;
    align-items:center; justify-content:center; z-index:9999; padding: 16px; 
  }
  .modal{ 
    width:500px; max-width: 100%; 
    background:var(--card); padding: 24px; border-radius:12px; 
    box-shadow:0 12px 40px rgba(0,0,0,0.35); 
  }
  input,select,textarea{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--bg); color: var(--text); font-size:14px; font-family:'Inter', system-ui, Roboto, Arial;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(217, 35, 45, 0.2);
  }
  textarea{min-height:120px;resize: vertical;}
  footer.small{ margin-top:32px; text-align:center; color:var(--muted); font-size:13px; }
  
  /* (BARU) HAPUS STYLE LOGIN */
  /* #loginScreen { ... Dihapus ... } */
  
  /* (BARU) Loading Screen (seperti dashboard.html) */
  .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #D9232D 0%, #F37321 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      z-index: 9999;
  }
  .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  @keyframes spin {
      to { transform: rotate(360deg); }
  }
  .loading-screen p {
      margin-top: 20px;
      font-size: 1.1rem;
      font-weight: 300;
  }
  /* (BARU) Sembunyikan konten aplikasi by default */
  .app-content { 
      display: none; 
  }

  /* (MEDIA QUERY) */
  @media (max-width: 768px) {
    body { padding: 16px; }
    .app { padding: 0; }
    
    .app-header { gap: 12px; }
    .controls { 
      margin-left: 0; width: 100%; 
      justify-content: space-between; 
      gap: 8px;
    }
    #userInfo { text-align: left; line-height: 1.4; }
    #newReportBtn { 
      padding: 9px 10px; 
      width: 100%; 
      justify-content: center;
      margin-top: 8px;
    } 
    #logoutBtn { position: absolute; top: 16px; right: 16px; } 

    .table-wrap { overflow: hidden; } 
    table { min-width: 0; }
    table thead {
      border: none; clip: rect(0 0 0 0);
      height: 1px; margin: -1px; overflow: hidden;
      padding: 0; position: absolute; width: 1px;
    }
    table tr {
      display: block;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 16px;
      padding: 12px;
      box-shadow: var(--shadow-sm);
    }
    table td {
      display: block;
      padding: 6px 0;
      border-bottom: none;
      font-size: 14px;
    }
    table td:not(:first-child) {
        border-top: 1px dashed var(--border-color);
        padding-top: 10px;
        margin-top: 4px;
    }
    table td:before {
      content: attr(data-label);
      display: block;
      font-weight: 600;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    table td[data-label="ID Laporan"] { padding-top: 0; }
    table td[data-label="ID Laporan"]::before { display: none; }
    table td[data-label="ID Laporan"] {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .status {
        padding: 6px 14px;
        width: 100%; 
        text-align: center;
    }
    .btn.urgent {
        width: 100%;
        text-align: center;
        padding: 8px;
    }
  }
</style>
</head>
<body data-theme="light">

<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>Memvalidasi Sesi Anda...</p>
</div>

<svg width="0" height="0" style="position:absolute">
  <defs>
    <svg id="icon-plus" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </defs>
</svg>

<div class="app app-content" id="app-content"> <header class="app-header">
    <div class="logo">ZP</div>
    <div class="title"><div class="name">Zeppelin</div><div class="tag">User Dashboard (IT Support)</div></div>
    <div class="controls">
      <div id="userInfo" class="small" style="text-align: right;">
        Selamat datang,<br>
        <strong id="userNameDisplay"></strong> </div>
      <button id="logoutBtn" class="btn ghost" title="Logout">Logout</button>
      <button id="newReportBtn" class="btn">
        <svg><use href="#icon-plus" /></svg>
        Buat Laporan Baru
      </button>
    </div>
  </header>

  <main id="mainContent">
    
    <h3>Ringkasan Laporan</h3>
    <div class="summary-grid">
      <div class="card summary-card" id="summary-open">
        <div class="small">Open</div>
        <div class="count" id="openCount">0</div>
      </div>
      <div class="card summary-card" id="summary-progress">
        <div class="small">In Progress</div>
        <div class="count" id="progressCount">0</div>
      </div>
      <div class="card summary-card" id="summary-closed">
        <div class="small">Closed</div>
        <div class="count" id="closedCount">0</div>
      </div>
    </div>
    
    <h3 class="section-title" style="margin-top: 24px;">Semua Laporan Saya</h3>
    <div class="card" style="margin-top: 12px; padding: 12px;"> <div class="table-wrap">
        <table id="reportTable" aria-describedby="Daftar laporan saya">
          <thead>
            <tr>
              <th>ID Laporan</th>
              <th>Jenis Masalah</th>
              <th>Deskripsi</th>
              <th>PIC</th> <th>Status</th>
              <th>Dibuat</th>
              <th>Aksi</th> </tr>
          </thead>
          <tbody>
             </tbody>
        </table>
      </div>
    </div>
  </main>
  <footer class="small">Zeppelin IT Support â€” <span id="footerDate"></span></footer>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Buat Laporan Baru</h3>
    <form id="modalForm" onsubmit="return false;">
      <div>
        <label class="small">Nama Pelapor</label>
        <input id="m_nama" required readonly> </div>
      <div style="margin-top:10px">
        <label class="small">Jenis Masalah</label>
        <select id="m_jenis" required>
          <option value="">Pilihâ€¦</option>
          <option>Jaringan</option>
          <option>Hardware</option>
          <option>Software</option>
          <option>Login / Akun</option>
          <option>Lainnya</option>
        </select>
      </div>
      <div style="margin-top:10px">
        <label class="small">Deskripsi Masalah</label>
        <textarea id="m_catatan" placeholder="Jelaskan masalah Anda di sini..." required></textarea>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalSave" class="btn">Kirim Laporan</button>
        <button id="modalCancel" type="button" class="btn ghost">Batal</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
// === KONFIGURASI FIREBASE (v10+) ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
    getDatabase, 
    ref, 
    set, 
    push, 
    update,
    get, 
    onValue, 
    runTransaction, 
    query, 
    orderByChild, 
    equalTo,
    off // (BARU) Untuk mematikan listener
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
Â  authDomain: "it-support-53eeb.firebaseapp.com",
Â  databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
Â  projectId: "it-support-53eeb",
Â  storageBucket: "it-support-53eeb.firebasestorage.app",
Â  messagingSenderId: "573924501146",
Â  appId: "1:573924501146:web:12f34306ed675472322123",
Â  measurementId: "G-33K6DDE1VR"
};

// Inisialisasi Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Referensi Database
const reportsRef = ref(db, 'reports'); 
const counterRef = ref(db, 'counter'); 
const usersRef = ref(db, 'users');

/* Cache & State */
let myReportsCache = []; 
let currentUser = null; 
let currentUserData = {};
let dbListener = null; // (BARU) Menyimpan referensi listener

/* DOM Elements */
const loadingScreen = document.getElementById('loading-screen');
const appContent = document.getElementById('app-content');
const userNameDisplay = document.getElementById('userNameDisplay');

/* Utilities */
function nowString(){ return new Date().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }); }
function isoNow(){ return new Date().toISOString(); }

function showToast(txt, t=2500){ 
    const el = document.createElement('div'); 
    el.className='card'; 
    el.style.position='fixed'; el.style.right='18px'; el.style.bottom='18px'; 
    el.style.padding='10px 12px'; el.style.zIndex=99999; 
    el.style.background = 'var(--primary)'; el.style.color = '#fff'; 
    el.textContent = txt; 
    document.body.appendChild(el); 
    setTimeout(()=>el.remove(),t); 
}

/* (BARU) AUTH GUARD (Validasi Sesi) */
onAuthStateChanged(auth, (user) => {
    if (user) {
        // User login, cek status approval
        currentUser = user;
        const userRef = ref(db, 'users/' + user.uid);

        get(userRef).then(snapshot => {
            if (snapshot.exists() && snapshot.val().status === 'approved') {
                // === DISETUJUI ===
                currentUserData = snapshot.val();
                userNameDisplay.textContent = currentUserData.nama;
                
                loadingScreen.style.display = 'none'; 
                appContent.style.display = 'block'; 
                
                // Mulai mendengarkan laporan
                startDbListener(user.uid);
                
            } else if (snapshot.exists() && snapshot.val().status === 'pending') {
                // === PENDING ===
                alert("Akun Anda untuk User Dashboard sedang menunggu persetujuan Admin.");
                signOut(auth).then(() => window.location.href = 'login.html');
            
            } else if (snapshot.exists() && snapshot.val().status === 'rejected') {
                // === DITOLAK ===
                alert("Akun Anda ditolak oleh Admin. Hubungi support.");
                signOut(auth).then(() => window.location.href = 'login.html');
            
            } else {
                // === DATA TIDAK ADA / STATUS KOSONG ===
                alert("Data user tidak ditemukan/valid. Hubungi Admin.");
                signOut(auth).then(() => window.location.href = 'login.html');
            }
        }).catch(err => {
            alert("Gagal memverifikasi data user: " + err.message);
            signOut(auth).then(() => window.location.href = 'login.html');
        });
        
    } else {
      // === USER TIDAK LOGIN ===
      currentUser = null;
      currentUserData = {};
      stopDbListener(); // Matikan listener
      window.location.href = 'login.html'; // Arahkan ke login
    }
});

/* (BARU) Fungsi untuk memulai & menghentikan listener DB */
function startDbListener(uid) {
    if (dbListener) stopDbListener(); // Hentikan listener lama jika ada

    const myReportsQuery = query(reportsRef, orderByChild('uid'), equalTo(uid));
    
    // Simpan referensi fungsi listener
    dbListener = onValue(myReportsQuery, (snapshot) => {
        const dataObj = snapshot.val();
        myReportsCache = dataObj ? Object.keys(dataObj).map(key => ({ ...dataObj[key], id: key })) : [];
        renderTable();
        renderUserDashboard();
        console.log('Laporan saya dimuat dari Firebase (v10).');
    }, (error) => {
        console.error("Firebase read failed:", error);
    });
}

function stopDbListener() {
    if (dbListener) {
        off(dbListener); // (v10) Mematikan listener
        dbListener = null;
        myReportsCache = [];
        renderTable();
        renderUserDashboard();
        console.log('Listener DB dimatikan.');
    }
}


/* (SAMA) Render User Dashboard (Summary Cards) */
function renderUserDashboard() {
    const byStatus = {Open:0,Progress:0,Closed:0};
    myReportsCache.forEach(r => {
        byStatus[r.status] = (byStatus[r.status] || 0) + 1;
    });
    document.getElementById('openCount').textContent = byStatus.Open;
    document.getElementById('progressCount').textContent = byStatus.Progress;
    document.getElementById('closedCount').textContent = byStatus.Closed;
}

/* (SAMA) Render Table */
function renderTable(){
  const tbody = document.querySelector('#reportTable tbody');
  myReportsCache.sort((a,b)=> new Date(b.created_iso) - new Date(a.created_iso));
  
  if (myReportsCache.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted); padding: 20px;">Anda belum membuat laporan.</td></tr>`;
      return;
  }
  tbody.innerHTML = myReportsCache.map(r=>{
    const statusClass = r.status==='Open'?'s-open':(r.status==='Progress'?'s-progress':'s-closed');
    const created = r.created || '-';
    const deskripsi = (r.catatan||'').substring(0, 100) + ((r.catatan||'').length > 100 ? '...' : '');
    const pic = r.pic || '...'; 
    const urgentButton = r.status !== 'Closed' 
      ? `<button class="btn urgent" onclick="markUrgent('${r.id}')" title="Tandai sebagai urgent">ðŸ”¥ Urgent</button>`
      : '<span>-</span>';
    
    return `<tr>
      <td data-label="ID Laporan">${r.id}</td>
      <td data-label="Jenis Masalah">${r.jenis}</td>
      <td data-label="Deskripsi">${deskripsi}</td>
      <td data-label="PIC">${pic}</td> <td data-label="Status"><span class="status ${statusClass}">${r.status}</span></td>
      <td data-label="Dibuat">${created}</td>
      <td data-label="Aksi">${urgentButton}</td> </tr>`;
  }).join('');
}

/* (DIUBAH) Fungsi Urgent (v10) */
async function markUrgent(id) {
    if (!currentUser) { alert("Sesi Anda berakhir. Silakan login ulang."); return; }
    
    const report = myReportsCache.find(r => r.id === id);
    if (report && report.urgent) {
        alert('Laporan ini sudah ditandai sebagai urgent.');
        return;
    }
    if (!confirm('Anda yakin ingin menandai laporan ini sebagai URGENT? Admin akan segera dinotifikasi.')) return;

    const specificReportRef = ref(db, 'reports/' + id); // (v10)
    const logRef = ref(db, 'reports/' + id + '/logs'); // (v10)
    const now = nowString();
    const iso = isoNow();
    const userName = currentUserData.nama || currentUser.email;

    try {
        await update(specificReportRef, { urgent: true }); // (v10)
        await push(logRef, { // (v10)
            time: now,
            iso: iso,
            detail: `ðŸ”¥ USER (${userName}) MENANDAI SEBAGAI URGENT.`
        });
        showToast('Laporan ditandai sebagai Urgent! âœ…');
    } catch (err) {
        console.error("Gagal menandai urgent:", err);
        alert("Gagal menandai urgent: " + err.message);
    }
}
window.markUrgent = markUrgent; // Expose ke global

/* (DIUBAH) Generate ID (v10) */
async function generateId() {
  try {
    // (v10) Transaksi
    const result = await runTransaction(counterRef, (currentValue) => (currentValue || 0) + 1);
    
    if (result.committed) {
      const nextId = result.snapshot.val();
      return 'ZP-' + String(nextId).padStart(4, '0');
    } else { throw new Error('Gagal mendapatkan ID baru (transaksi dibatalkan).'); }
  } catch (error) {
    console.error("Gagal generate ID:", error);
    alert("Error: Tidak bisa mendapatkan ID baru dari server. Coba lagi.");
    return null;
  }
}

/* (DIUBAH) Init (Tanpa Auth, hanya event listener) */
(function init(){
  document.getElementById('footerDate').textContent = new Date().toLocaleDateString('id-ID', { year: 'numeric' });
  document.getElementById('newReportBtn').addEventListener('click', ()=>openModal());
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth); // (v10)
  });
})();

/* (SAMA) MODAL BUAT LAPORAN */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalForm = document.getElementById('modalForm');

function openModal(){
  modalForm.reset(); 
  document.getElementById('m_nama').value = currentUserData.nama || currentUser.email;
  modalBackdrop.style.display = 'flex';
}
document.getElementById('modalCancel').addEventListener('click', ()=>{ modalBackdrop.style.display='none'; });

/* (DIUBAH) Save Laporan (v10) */
document.getElementById('modalSave').addEventListener('click', async (e)=>{
  e && e.preventDefault();
  
  if (!currentUser) { alert("Sesi Anda berakhir. Silakan login ulang."); return; }
  
  const jenis = document.getElementById('m_jenis').value;
  const catatan = document.getElementById('m_catatan').value;
  
  if(!jenis || !catatan){ alert('Jenis Masalah dan Deskripsi wajib diisi.'); return; }

  const id = await generateId(); 
  if (!id) return; 
  
  const now = nowString();
  const iso = isoNow();
  const userName = currentUserData.nama || currentUser.email; 

  const entry = {
    id: id,
    uid: currentUser.uid, 
    nama: userName,       
    jenis: jenis,
    catatan: catatan,
    status: "Open", 
    pic: null,      
    kategori: null,  
    urgent: false, 
    created: now,
    created_iso: iso,
    updated: null,
    updated_iso: null,
    durationMs: null,
    durationText: '-',
    logs: [
        { time: now, iso: iso, detail: `Laporan dibuat oleh ${userName}.` }
    ]
  };

  try {
    const specificReportRef = ref(db, 'reports/' + id); // (v10)
    await set(specificReportRef, entry); // (v10)
    showToast('Laporan baru berhasil dikirim âœ…');
    modalBackdrop.style.display='none';
  } catch (err) {
    console.error("Gagal menyimpan:", err);
    alert("Gagal mengirim laporan: " + err.message);
  }
});

</script>

</body>
</html>
